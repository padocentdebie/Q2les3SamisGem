<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <title>Proces-Verbaal Oefening - Dossier Samir</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <style>
        :root {
            --primary-blue: #1d4e89;
            --accent-gold: #f9d423;
            --border-gray: #cbd5e0;
            --bg-light: #f4f7f9;
            --text-main: #2d3748;
            --success-green: #28a745;
        }

        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            background-color: var(--bg-light);
            color: var(--text-main);
            margin: 0;
            padding: 40px 20px;
        }

        .container {
            max-width: 950px;
            margin: auto;
            background: white;
            padding: 40px;
            border-radius: 4px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .header {
            color: var(--primary-blue);
            border-bottom: 3px solid var(--accent-gold);
            text-transform: uppercase;
            text-align: center;
            padding-bottom: 15px;
            margin-bottom: 30px;
            letter-spacing: 1px;
        }

        .stap-box {
            background: #ffffff;
            border: 1px solid var(--border-gray);
            border-left: 5px solid var(--primary-blue);
            padding: 25px;
            margin-bottom: 25px;
        }

        h3 { margin-top: 0; color: var(--primary-blue); font-size: 1.1em; }

        .action-button {
            display: inline-block;
            background: var(--primary-blue);
            color: white !important;
            padding: 12px 24px;
            text-decoration: none;
            border-radius: 4px;
            font-weight: bold;
            font-size: 0.9em;
            text-transform: uppercase;
        }

        input[type="text"], textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border-gray);
            border-radius: 4px;
            box-sizing: border-box;
            font-family: inherit;
            margin-bottom: 10px;
        }

        .submit-btn {
            background: var(--success-green);
            color: white;
            border: none;
            padding: 15px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            width: 100%;
            text-transform: uppercase;
        }

        .aangifte-kaart {
            border: 1px solid var(--border-gray);
            margin-top: 20px;
            padding: 20px;
            border-radius: 4px;
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
            background: #fff;
        }

        @media (min-width: 768px) {
            .aangifte-kaart { grid-template-columns: 1fr 320px; }
        }

        .tekst-weergave { 
            white-space: pre-wrap; 
            background: #f8fafc; 
            padding: 15px; 
            border-radius: 4px; 
            border: 1px solid #edf2f7; 
            font-size: 0.95em; 
            color: #000; /* Zorg voor puur zwart voor PDF export */
        }

        .btn-group { display: flex; gap: 10px; margin-top: 15px; }

        .secondary-btn {
            background: none;
            border: 1px solid var(--primary-blue);
            color: var(--primary-blue);
            padding: 8px 14px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8em;
            font-weight: bold;
            text-transform: uppercase;
        }

        .pdf-btn { border-color: #e53e3e; color: #e53e3e; }

        .feedback-kolom { background: #fffdf2; border: 1px solid #f9d423; padding: 15px; border-radius: 4px; display: none; }
        
        .save-fb-btn {
            background: var(--primary-blue);
            color: white;
            border: none;
            padding: 8px;
            width: 100%;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8em;
            margin-top: 5px;
        }

        .vinklijst { list-style: none; padding: 0; margin: 0 0 15px 0; }
        .vinklijst li { font-size: 0.85em; margin-bottom: 6px; display: flex; align-items: center; color: #000; }
        .vinklijst input { margin-right: 10px; }

        .admin-zone {
            margin-top: 100px;
            padding: 30px;
            border: 2px dashed #cbd5e0;
            text-align: center;
            background: #fff;
        }

        .wis-btn-groot {
            background: #e53e3e;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            text-transform: uppercase;
        }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1>Dossier: Aangifte van Samir</h1>
    </div>

    <div class="stap-box">
        <h3>1. Informatieverzameling</h3>
        <p>Stel de juiste vragen aan Samir om het dossier compleet te maken via de 7 Gouden W's.</p>
        <center>
            <a href="https://gemini.google.com/gem/e6e35023ee68" target="_blank" class="action-button">Start verhoormodule</a>
        </center>
    </div>

    <div class="stap-box">
        <h3>2. Proces-Verbaal Inleveren</h3>
        <p style="font-size: 0.85em; color: #718096; margin-bottom: 10px;">Vul alleen je voornaam in in verband met privacy.</p>
        <input type="text" id="student-naam" placeholder="Je voornaam">
        <textarea id="input-tekst" placeholder="Typ hier de officiÃ«le aangifte tekst (ik-vorm, OVT)..." style="height: 180px;"></textarea>
        <button class="submit-btn" onclick="verstuurData()">Publiceer voor de klas</button>
    </div>

    <h2 style="color: var(--primary-blue); margin-top: 50px; font-size: 1.2em; border-bottom: 1px solid var(--border-gray); padding-bottom: 10px;">Live Feed</h2>
    <div id="live-feed">Wachten op inzendingen...</div>

    <div class="admin-zone">
        <h4 style="margin-top:0; color:#718096;">DOCENTENBEHEER</h4>
        <p style="font-size:0.85em; color:#718096;">Verwijder alle gegevens na afloop van de les om de sessie te resetten.</p>
        <button class="wis-btn-groot" onclick="wisAlles()">Wis alle teksten uit sessie</button>
    </div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyBj8dXkl1rEfyx54_MDy_tYd2P7kAeU8VQ",
        authDomain: "q2les3samirgem.firebaseapp.com",
        databaseURL: "https://q2les3samirgem-default-rtdb.europe-west1.firebasedatabase.app/",
        projectId: "q2les3samirgem",
        storageBucket: "q2les3samirgem.firebasestorage.app",
        messagingSenderId: "8681998187",
        appId: "1:8681998187:web:fd08067494a010dc572e2e"
    };

    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    function verstuurData() {
        const naam = document.getElementById('student-naam').value;
        const tekst = document.getElementById('input-tekst').value;
        if(!naam || !tekst) return alert("Voornaam en tekst zijn verplicht.");

        database.ref('aangiftes').push({
            naam: naam,
            tekst: tekst,
            feedback: { v1:false, v2:false, v3:false, v4:false, v5:false, v6:false, v7:false, v8:false, opmerking: "" }
        });
        document.getElementById('input-tekst').value = '';
    }

    function saveFeedback(key) {
        const opm = document.getElementById('opm-' + key).value;
        database.ref('aangiftes/' + key + '/feedback').update({ opmerking: opm });
        alert("Feedback succesvol opgeslagen.");
    }

    function updateCheck(key, field, value) {
        database.ref('aangiftes/' + key + '/feedback').update({ [field]: value });
    }

    database.ref('aangiftes').on('value', (snapshot) => {
        const feed = document.getElementById('live-feed');
        feed.innerHTML = '';
        const data = snapshot.val();
        if (data) {
            Object.keys(data).reverse().forEach(key => {
                const item = data[key];
                const fb = item.feedback || {};
                const kaart = document.createElement('div');
                kaart.className = 'aangifte-kaart';
                kaart.id = 'export-' + key;
                kaart.innerHTML = `
                    <div>
                        <strong style="color:var(--primary-blue); display:block; margin-bottom:10px;">Verbalisant: ${item.naam}</strong>
                        <div class="tekst-weergave">${item.tekst}</div>
                        <div class="btn-group">
                            <button class="secondary-btn" onclick="toggleFB('${key}')">Feedbackpaneel</button>
                            <button class="secondary-btn pdf-btn" onclick="downloadPDF('${key}', '${item.naam}')">Download PDF</button>
                        </div>
                    </div>
                    <div class="feedback-kolom" id="fb-${key}">
                        <strong>CONTROLELIJST</strong>
                        <ul class="vinklijst">
                            <li><input type="checkbox" ${fb.v1?'checked':''} onchange="updateCheck('${key}','v1',this.checked)"> Bestanddeeltekst</li>
                            <li><input type="checkbox" ${fb.v2?'checked':''} onchange="updateCheck('${key}','v2',this.checked)"> Gouden W's</li>
                            <li><input type="checkbox" ${fb.v3?'checked':''} onchange="updateCheck('${key}','v3',this.checked)"> Redenen van wetenschap</li>
                            <li><input type="checkbox" ${fb.v4?'checked':''} onchange="updateCheck('${key}','v4',this.checked)"> Ik-vorm</li>
                            <li><input type="checkbox" ${fb.v5?'checked':''} onchange="updateCheck('${key}','v5',this.checked)"> Onvoltooid verleden tijd</li>
                            <li><input type="checkbox" ${fb.v6?'checked':''} onchange="updateCheck('${key}','v6',this.checked)"> Voor delict</li>
                            <li><input type="checkbox" ${fb.v7?'checked':''} onchange="updateCheck('${key}','v7',this.checked)"> Tijdens delict</li>
                            <li><input type="checkbox" ${fb.v8?'checked':''} onchange="updateCheck('${key}','v8',this.checked)"> Na delict</li>
                        </ul>
                        <strong>OPMERKINGEN</strong>
                        <textarea id="opm-${key}" style="height: 80px; font-size: 0.85em; margin-top:5px;">${fb.opmerking || ""}</textarea>
                        <button class="save-fb-btn" onclick="saveFeedback('${key}')">Feedback Opslaan</button>
                    </div>
                `;
                feed.appendChild(kaart);
            });
        }
    });

    function toggleFB(id) {
        const el = document.getElementById('fb-' + id);
        el.style.display = (el.style.display === 'block') ? 'none' : 'block';
    }

    function downloadPDF(id, naam) {
        const element = document.getElementById('export-' + id);
        const fbPaneel = document.getElementById('fb-' + id);
        const wasVerborgen = fbPaneel.style.display === 'none';
        
        // Zorg dat het paneel zichtbaar is voor de scan
        fbPaneel.style.display = 'block';

        const opt = {
            margin: 10,
            filename: `PV_Aangifte_${naam}.pdf`,
            image: { type: 'jpeg', quality: 0.98 },
            html2canvas: { 
                scale: 2, 
                useCORS: true, 
                letterRendering: true 
            },
            jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
        };

        // Kleine vertraging om rendering te garanderen
        setTimeout(() => {
            html2pdf().set(opt).from(element).save().then(() => {
                if(wasVerborgen) fbPaneel.style.display = 'none';
            });
        }, 500);
    }

    function wisAlles() {
        if(confirm("Weet u zeker dat u alle ingeleverde teksten wilt verwijderen?")) {
            database.ref('aangiftes').remove();
        }
    }
</script>

</body>
</html>
